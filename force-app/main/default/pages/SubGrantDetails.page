<apex:page
  controller="SubGrantDetailsController"
  showHeader="false"
  sidebar="false"
  docType="html-5.0"
>
  <head>
    <title>Sub-Grant Details</title>
  </head>
  <c:Header
    ActivePage="grants"
    acct="{!userAcct}"
    profile="{!currentUser.Profile.Name}"
  />

  <apex:form id="form">
    <div class="main-panel">
      <div class="content">
        <c:BBBSSubGrantDetails
          grant="{!grant}"
          approverLevel="{!approverLevel}"
          statusColor="{!statusColor}"
          showAwardPopup="{!showAwardPopup}"
        />

        <c:ErrorMessage
          type="info"
          rendered="{!CONTAINS(grant.Name, 'JJ7')}"
          errorMessage="A No-Cost Extension was granted for JJ7 2017-JU-FX-0002, making the subgrantee performance period 10/1/2017 – 12/31/2018"
        />
        <c:ErrorMessage
          type="info"
          rendered="{!CONTAINS(grant.Name, 'JJ7')}"
          errorMessage="Personnel Start Date and End Date are for budget line item calculation purposes only"
        />

        <apex:outputPanel
          id="lists"
          rendered="{!NOT(isNationalSubGrant) || CONTAINS(approverLevel, 'Admin')}"
        >
          <apex:outputPanel rendered="{!hasLabor}">
            <div class="panel panel-default">
              <apex:repeat value="{!labor_map}" var="cat">
                <div class="panel-heading">
                  <apex:outputText value="{!cat}" />
                </div>
                <div class="panel-body">
                  <table style="width: 100%">
                    <tr>
                      <th>Name</th>
                      <th>Title</th>
                      <th>Active?</th>
                      <th>Hourly?</th>
                      <th>Rate</th>
                      <th>% Time on Grant</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Item Budget</th>
                      <th>
                        <apex:outputText
                          value="New Item Budget"
                          rendered="{!editMode}"
                        />
                      </th>
                      <th>
                        <apex:outputText
                          value="Requested Salary"
                          rendered="{!NOT(editMode)}"
                        />
                      </th>
                      <th>
                        <apex:outputText
                          value="Approved Salary"
                          rendered="{!NOT(editMode)}"
                        />
                      </th>
                      <th>Item Balance</th>
                    </tr>
                    <apex:repeat value="{!labor_map[cat]}" var="i">
                      <tr>
                        <td>{!i.Name}</td>
                        <td>{!i.Title__c}</td>
                        <td>
                          <apex:outputField value="{!i.Is_Active__c}" />
                        </td>
                        <td>
                          <apex:outputField value="{!i.Is_Hourly__c}" />
                        </td>
                        <td>
                          <apex:outputfield
                            value="{!i.Hourly_Rate__c }"
                            rendered="{!i.Is_Hourly__c}"
                          />
                          <apex:outputfield
                            value="{!i.Salary__c }"
                            rendered="{!NOT(i.Is_Hourly__c)}"
                          />
                        </td>
                        <td>{!i.Projected_Percent_Time_on_Grant__c}%</td>
                        <td>
                          <apex:outputText value="{0, date, MM'/'dd'/'yyyy}">
                            <apex:param value="{!i.Start_Date__c}" />
                          </apex:outputText>
                        </td>
                        <td>
                          <apex:outputText value="{0, date, MM'/'dd'/'yyyy}">
                            <apex:param value="{!i.End_Date__c}" />
                          </apex:outputText>
                        </td>
                        <td>
                          <apex:outputfield value="{!i.Item_Budget__c}" />
                        </td>
                        <td>
                          <strong>
                            <apex:outputfield
                              value="{!i.New_Item_Budget__c}"
                              rendered="{!editMode && i.Item_Budget__c != i.New_Item_Budget__c}"
                            />
                          </strong>
                        </td>
                        <td>
                          <apex:outputfield
                            value="{!i.Total_Requested_Salary__c}"
                            rendered="{!NOT(editMode)}"
                          />
                        </td>
                        <td>
                          <apex:outputfield
                            value="{!i.Total_Approved_Salary__c}"
                            rendered="{!NOT(editMode)}"
                          />
                        </td>
                        <td>
                          <apex:outputfield
                            value="{!i.BBBS_Personnel_Item_Balance__c}"
                          />
                        </td>
                      </tr>
                    </apex:repeat>
                  </table>
                </div>

                <div class="panel-heading sub-panel-heading">
                  Fringe Benefits
                </div>
                <div class="panel-body">
                  <table style="width: 100%">
                    <tr>
                      <th>Name</th>
                      <th>FICA (7.65%)</th>
                      <th>Medical</th>
                      <th>Dental</th>
                      <th>Short Term Disability</th>
                      <th>Long Term Disability</th>
                      <th>Life</th>
                      <th>Other</th>
                      <th>Total Fringe Benefits</th>
                      <th>
                        <apex:outputText
                          value="New Fringe Benefits"
                          rendered="{!editMode}"
                        />
                      </th>
                      <th>
                        <apex:outputText
                          value="Requested Benefits"
                          rendered="{!NOT(editMode)}"
                        />
                      </th>
                      <th>
                        <apex:outputText
                          value="Approved Benefits"
                          rendered="{!NOT(editMode)}"
                        />
                      </th>
                      <th>Notes</th>
                    </tr>
                    <apex:repeat value="{!labor_map[cat]}" var="i">
                      <tr>
                        <td>{!i.Name}</td>
                        <td>
                          <apex:outputField value="{!i.FICA__c}" />
                        </td>
                        <td>
                          <apex:outputField value="{!i.Medical__c}" />
                        </td>
                        <td>
                          <apex:outputField value="{!i.Dental__c}" />
                        </td>
                        <td>
                          <apex:outputField
                            value="{!i.Short_Term_Disability__c}"
                          />
                        </td>
                        <td>
                          <apex:outputField
                            value="{!i.Long_Term_Disability__c}"
                          />
                        </td>
                        <td>
                          <apex:outputField value="{!i.Life__c}" />
                        </td>
                        <td>
                          <apex:outputField value="{!i.Other_Benefits__c}" />
                        </td>
                        <td>
                          <apex:outputField value="{!i.Fringe_Benefits__c}" />
                        </td>
                        <td>
                          <apex:outputField
                            value="{!i.New_Fringe_Benefits__c}"
                            rendered="{!editMode && i.Fringe_Benefits__c != i.New_Fringe_Benefits__c}"
                          />
                        </td>
                        <td>
                          <apex:outputfield
                            value="{!i.Total_Requested_Benefits__c}"
                            rendered="{!NOT(editMode)}"
                          />
                        </td>
                        <td>
                          <apex:outputfield
                            value="{!i.Total_Approved_Benefits__c}"
                            rendered="{!NOT(editMode)}"
                          />
                        </td>
                        <td>
                          <apex:commandLink
                            action="{!showLaborNotesPopup}"
                            status="pageStatus"
                            reRender="laborPopup"
                          >
                            <apex:outputText
                              rendered="{!i.Item_Note__c != null || i.Response__c != null}"
                            >
                              <span class="glyphicon glyphicon-comment"></span>
                            </apex:outputText>
                            <apex:outputText
                              rendered="{!userAcct.RecordType.Name == 'National Organization' && i.Response__c == null && i.Item_Note__c == null}"
                              >+</apex:outputText
                            >
                          </apex:commandLink>
                          <apex:outputPanel id="laborPopup">
                            <apex:outputPanel
                              styleClass="popupBackground"
                              layout="block"
                              rendered="{!displayLaborNotesPopup}"
                            />
                            <apex:outputPanel
                              styleClass="custPopup"
                              layout="block"
                              rendered="{!displayLaborNotesPopup}"
                            >
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h4 class="modal-title">
                                      Notes for &nbsp;<apex:outputText
                                        value="{!i.Name}"
                                      />
                                    </h4>
                                  </div>
                                  <div class="modal-body">
                                    <apex:outputPanel
                                      rendered="{!i.Item_Note__c != null}"
                                    >
                                      <apex:outputText
                                        value="{!i.Item_Note__c}"
                                      />
                                    </apex:outputPanel>
                                    <apex:outputPanel
                                      rendered="{!i.Item_Note__c == null}"
                                    >
                                      No notes from Affiliate
                                    </apex:outputPanel>
                                    <br />
                                    <hr />
                                    <apex:outputPanel
                                      rendered="{!userAcct.RecordType.Name == 'National Organization'}"
                                    >
                                      <apex:inputTextarea
                                        value="{!i.Response__c}"
                                      />
                                    </apex:outputPanel>
                                    <apex:outputPanel
                                      rendered="{!userAcct.RecordType.Name == 'Local Organization'}"
                                    >
                                      <apex:outputText
                                        value="{!i.Response__c}"
                                        rendered="{!i.Response__c != null}"
                                      />
                                      <apex:outputText
                                        value="No Notes from National"
                                        rendered="{!i.Response__c == null}"
                                      />
                                    </apex:outputPanel>
                                  </div>
                                  <div class="modal-footer">
                                    <apex:commandButton
                                      action="{!closeLaborNotesPopup}"
                                      value="Close"
                                      status="pageStatus"
                                      reRender="form"
                                    />
                                  </div>
                                </div>
                              </div>
                            </apex:outputPanel>
                          </apex:outputPanel>
                        </td>
                      </tr>
                    </apex:repeat>
                  </table>
                </div>
              </apex:repeat>
            </div>
          </apex:outputPanel>

          <div class="panel panel-default">
            <div class="panel-heading">
              <apex:outputText value="Personnel & Fringe Notes" />
            </div>
            <div class="panel-body">
              <apex:outputText
                value="{!grant.Labor_Notes__c}"
                rendered="{!grant.Labor_Notes__c != null}"
              />
              <apex:outputText
                value="No notes from Affiliate"
                rendered="{!grant.Labor_Notes__c == null}"
              />
              <hr />
              <apex:outputPanel
                rendered="{!CONTAINS(approverLevel, 'Level Two') || approverLevel == 'Level Two Admin' || approverLevel == 'Level Three'}"
              >
                Notes from National:
                <apex:inputTextarea value="{!grant.Labor_Response__c}" />
              </apex:outputPanel>
              <apex:outputPanel
                rendered="{!NOT(CONTAINS(approverLevel, 'Level Two')) && NOT(approverLevel == 'Level Three')}"
              >
                <apex:outputText
                  value="No notes from National"
                  rendered="{!grant.Labor_Response__c == null}"
                />
                <apex:outputText
                  value="Notes from National: "
                  rendered="{!grant.Labor_Response__c != null}"
                />
                <apex:outputText value="{!grant.Labor_Response__c}" />
              </apex:outputPanel>
            </div>
          </div>

          <apex:outputPanel rendered="{!hasExpenses}">
            <div class="panel panel-default">
              <div class="panel-heading">Expenses</div>
              <apex:repeat value="{!expense_map}" var="cat">
                <div class="panel-heading sub-panel-heading">
                  <apex:outputText value="{!cat}" />
                </div>
                <div class="panel-body">
                  <table style="width: 100%">
                    <tr>
                      <th style="width: 200px">Name</th>
                      <th>Total Expense</th>
                      <th>
                        <apex:outputText
                          value="Factor Type"
                          rendered="{!grant.Use_Indirect_Rate__c != 'Yes'}"
                        />
                      </th>
                      <th>
                        <apex:outputText
                          value="Factor Value"
                          rendered="{!grant.Use_Indirect_Rate__c != 'Yes'}"
                        />
                      </th>
                      <th>Item Budget</th>
                      <th>
                        <apex:outputText
                          value="New Item Budget"
                          rendered="{!editMode}"
                        />
                      </th>
                      <th>
                        <apex:outputText
                          value="Requested Amount"
                          rendered="{!NOT(editMode)}"
                        />
                      </th>
                      <th>
                        <apex:outputText
                          value="Approved Amount"
                          rendered="{!NOT(editMode)}"
                        />
                      </th>
                      <th>Item Balance</th>
                      <th>Notes</th>
                    </tr>
                    <apex:repeat value="{!expense_map[cat]}" var="i">
                      <tr>
                        <td>{!i.Name}</td>
                        <td>
                          <apex:outputfield value="{!i.Total_Expense__c}" />
                        </td>
                        <td>
                          <apex:outputField
                            value="{!i.Factor_Type__c}"
                            rendered="{!grant.Use_Indirect_Rate__c != 'Yes'}"
                          />
                        </td>
                        <td>
                          <apex:outputPanel
                            rendered="{!grant.Use_Indirect_Rate__c != 'Yes'}"
                          >
                            <apex:outputText
                              value="{!grant.Estimated_FTE__c}"
                              rendered="{!i.Factor_Type__c == 'FTE'}"
                            />
                            <apex:outputText
                              value="{!grant.Youth_Served_Percent__c}"
                              rendered="{!i.Factor_Type__c == 'TCS'}"
                            />
                            <apex:outputText
                              value="{!i.Other_Factor_Percent__c}"
                              rendered="{!i.Factor_Type__c == 'Other'}"
                            />
                            <apex:outputText value="%" />
                          </apex:outputPanel>
                        </td>
                        <td>
                          <apex:outputfield value="{!i.Item_Budget__c}" />
                        </td>
                        <td>
                          <strong>
                            <apex:outputfield
                              value="{!i.New_Item_Budget__c}"
                              rendered="{!editMode}"
                            />
                          </strong>
                        </td>
                        <td>
                          <apex:outputfield
                            value="{!i.Total_Requested_Amount__c}"
                            rendered="{!NOT(editMode)}"
                          />
                        </td>
                        <td>
                          <apex:outputfield
                            value="{!i.Total_Approved_Amount__c}"
                            rendered="{!NOT(editMode)}"
                          />
                        </td>
                        <td>
                          <apex:outputfield value="{!i.Item_Balance__c}" />
                        </td>
                        <td>
                          <apex:commandLink
                            action="{!showExpenseNotesPopup}"
                            status="pageStatus"
                            reRender="expensePopup"
                          >
                            <apex:outputText
                              rendered="{!i.Item_Note__c != null || i.Response__c != null}"
                            >
                              <span class="glyphicon glyphicon-comment"></span>
                            </apex:outputText>
                            <apex:outputText
                              rendered="{!userAcct.RecordType.Name == 'National Organization' && i.Response__c == null && i.Item_Note__c == null}"
                              >+</apex:outputText
                            >
                          </apex:commandLink>
                          <apex:outputPanel id="expensePopup">
                            <apex:outputPanel
                              styleClass="popupBackground"
                              layout="block"
                              rendered="{!displayExpenseNotesPopup}"
                            />
                            <apex:outputPanel
                              styleClass="custPopup"
                              layout="block"
                              rendered="{!displayExpenseNotesPopup}"
                            >
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h4 class="modal-title">
                                      Notes for &nbsp;<apex:outputText
                                        value="{!i.Name}"
                                      />
                                    </h4>
                                  </div>
                                  <div class="modal-body">
                                    <apex:outputPanel
                                      rendered="{!i.Item_Note__c != null}"
                                    >
                                      <apex:outputText
                                        value="{!i.Item_Note__c}"
                                      />
                                    </apex:outputPanel>
                                    <apex:outputPanel
                                      rendered="{!i.Item_Note__c == null}"
                                    >
                                      No notes from Affiliate
                                    </apex:outputPanel>
                                    <br />
                                    <hr />
                                    <apex:outputPanel
                                      rendered="{!userAcct.RecordType.Name == 'National Organization'}"
                                    >
                                      <apex:inputTextarea
                                        value="{!i.Response__c}"
                                      />
                                    </apex:outputPanel>
                                    <apex:outputPanel
                                      rendered="{!userAcct.RecordType.Name == 'Local Organization'}"
                                    >
                                      <apex:outputText
                                        value="{!i.Response__c}"
                                        rendered="{!i.Response__c != null}"
                                      />
                                      <apex:outputText
                                        value="No Notes from National"
                                        rendered="{!i.Response__c == null}"
                                      />
                                    </apex:outputPanel>
                                  </div>
                                  <div class="modal-footer">
                                    <apex:commandButton
                                      action="{!closeExpenseNotesPopup}"
                                      value="Close"
                                      status="pageStatus"
                                      reRender="form"
                                    />
                                  </div>
                                </div>
                              </div>
                            </apex:outputPanel>
                          </apex:outputPanel>
                        </td>
                      </tr>
                    </apex:repeat>
                  </table>
                </div>
              </apex:repeat>
            </div>
          </apex:outputPanel>

          <div class="panel panel-default">
            <div class="panel-heading">Expense Notes</div>
            <div class="panel-body">
              <apex:outputText
                value="{!grant.Expense_Notes__c}"
                rendered="{!grant.Expense_Notes__c != null}"
              />
              <apex:outputText
                value="No notes from Affiliate"
                rendered="{!grant.Expense_Notes__c == null}"
              />
              <hr />
              <apex:outputPanel
                rendered="{!CONTAINS(approverLevel, 'Level Two') || approverLevel == 'Level Three'}"
              >
                Notes from National:
                <apex:inputTextarea value="{!grant.Expense_Response__c}" />
              </apex:outputPanel>
              <apex:outputPanel
                rendered="{!NOT(CONTAINS(approverLevel, 'Level Two')) && NOT(approverLevel == 'Level Three')}"
              >
                <apex:outputText
                  value="No notes from National"
                  rendered="{!grant.Expense_Response__c == null}"
                />
                <apex:outputText
                  value="Notes from National: "
                  rendered="{!grant.Expense_Response__c != null}"
                />
                <apex:outputText value="{!grant.Expense_Response__c}" />
              </apex:outputPanel>
            </div>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">Attachments</div>
            <div class="panel-body">
              <apex:outputText rendered="{!att_list.size == 0}">
                No Attachments Found
              </apex:outputText>
              <apex:repeat value="{!att_list}" var="a">
                <div class="row">
                  <div class="col-xs-12">
                    <apex:outputLink
                      value="{!URLFOR($Action.Attachment.Download, a.Id)}"
                      style="margin-right: 10px"
                      target="_blank"
                    >
                      {!a.Name}
                    </apex:outputLink>
                    <apex:outputText rendered="{!a.Description != null}">
                      ({!a.Description})
                    </apex:outputText>
                  </div>
                </div>
              </apex:repeat>
            </div>
            <div class="panel-footer">
              <a
                class="btn"
                href="{!URLFOR($Site.Prefix+'/SubGrantDocuments?grantId=' + grant.Id)}"
              >
                View Grant Specific Documents
              </a>
            </div>
          </div>

          <apex:outputPanel rendered="{!grant.Use_Indirect_Rate__c == 'Yes'}">
            <div class="panel panel-default">
              <div class="panel-heading">Modified Direct Cost</div>
              <div class="panel-body grid-pd-sm">
                <div class="row">
                  <div class="col-xs-12">
                    <strong>Total Requested for Personnel: </strong>
                    <apex:outputText value="${0, number, ###,###,###,##0.00}">
                      <apex:param value="{!laborRequestedAmount}" />
                    </apex:outputText>
                  </div>
                </div>
                <div class="row">
                  <div class="col-xs-12">
                    <strong>Total Requested for Expenses: </strong>
                    <apex:outputText value="${0, number, ###,###,###,##0.00}">
                      <apex:param value="{!expenseRequestedAmount}" />
                    </apex:outputText>
                  </div>
                </div>
                <div class="row">
                  <div class="col-xs-12">
                    <strong>Total Indirect Cost: </strong>
                    ( &nbsp;
                    <apex:outputText value="${0, number, ###,###,###,##0.00}">
                      <apex:param value="{!laborRequestedAmount}" />
                    </apex:outputText>
                    + &nbsp;
                    <apex:outputText value="${0, number, ###,###,###,##0.00}">
                      <apex:param value="{!expenseRequestedAmount}" />
                    </apex:outputText>
                    ) * &nbsp;
                    <apex:outputText value="{!grant.Indirect_Rate__c}" />% =
                    &nbsp;
                    <strong>
                      <apex:outputField
                        value="{!grant.Indirect_Rate_Amount__c}"
                        rendered="{!NOT(editMode)}"
                      />
                      <apex:outputField
                        value="{!grant.New_Indirect_Rate_Amount__c}"
                        rendered="{!editMode}"
                      />
                    </strong>
                  </div>
                </div>
              </div>
            </div>
          </apex:outputPanel>

          <apex:outputPanel
            rendered="{!grant.Budget_Notes__c != null || userAcctType == 'National Organization'}"
          >
            <div class="panel panel-default">
              <div class="panel-heading">
                General Notes from National
                <div class="pull-right" style="margin-top: -5px">
                  <apex:commandButton
                    action="{!updateNotesPopup}"
                    value="Edit"
                    rendered="{!userAcctType == 'National Organization'}"
                    styleClass="btn-small btn-white"
                  />
                </div>
              </div>
              <div class="panel-body">
                <h5>Notes for Affiliate:</h5>
                <apex:outputField value="{!grant.Budget_Notes__c}" />
                <apex:outputPanel
                  rendered="{!userAcctType == 'National Organization'}"
                >
                  <br />
                  <hr />
                  <h5>Notes for National:</h5>
                  <apex:outputField value="{!grant.Notes_for_National__c}" />
                </apex:outputPanel>
              </div>
            </div>
          </apex:outputPanel>

          <apex:outputPanel
            rendered="{!userAcctType == 'National Organization'}"
          >
            <div class="panel panel-default">
              <div class="panel-heading">
                Modification History
                <a
                  data-toggle="collapse"
                  href="#collapse1"
                  class="toggle pull-right"
                ></a>
              </div>
              <div id="collapse1" class="panel-collapse collapse in">
                <div class="panel-body grid-pd-sm">
                  <apex:outputField value="{!grant.Modification_History__c}" />
                </div>
              </div>
            </div>
          </apex:outputPanel>

          <!-- BEGIN Page Actions -->
          <div class="row">
            <div class="col-xs-8">
              <apex:outputPanel
                rendered="{!userAcctType == 'National Organization'}"
              >
                <apex:commandButton
                  action="{!saveAndClose}"
                  value="Save and Close"
                  status="pageStatus"
                  styleClass="btn primary"
                />
              </apex:outputPanel>
              <apex:outputPanel rendered="{!grant.Grant_Status__c != 'Closed'}">
                <a
                  class="btn"
                  href="{!URLFOR($Site.Prefix+'/Reimbursements?GrantID='+GrantID)}"
                >
                  View Reimbursements
                </a>
                <apex:outputPanel
                  rendered="{!userAcctType == 'Local Organization' || (isNationalSubGrant && CONTAINS(approverLevel, 'Admin'))}"
                >
                  <apex:outputPanel rendered="{!updatePopupNeeded == false}">
                    <a
                      class="btn"
                      href="{!URLFOR($Site.Prefix+'/BBBSBudgetPersonnel?GrantID='+GrantID)}"
                    >
                      Update Budget
                    </a>
                  </apex:outputPanel>
                  <apex:commandButton
                    action="{!updatePopup}"
                    value="Update Budget"
                    rendered="{!updatePopupNeeded == true}"
                    reRender="updatePopup"
                  />
                  <apex:outputPanel
                    rendered="{!NOT(editMode) && grant.Grant_Status__c == 'Approved'}"
                  >
                    <!--<a class="btn" href="{!URLFOR($Site.Prefix+'/GranteeReportForm?GrantID='+GrantID)}">
                                            Create Report
                                        </a>-->
                    <a
                      class="btn primary"
                      href="{!URLFOR($Site.Prefix+'/RequestForm?GrantID='+GrantID)}"
                    >
                      Request Reimbursement
                    </a>
                  </apex:outputPanel>
                </apex:outputPanel>
                <apex:outputPanel
                  rendered="{!editMode && NOT(isNationalSubGrant) && userAcctType == 'National Organization'}"
                >
                  <apex:outputPanel
                    rendered="{!grant.Grant_Status__c != 'Revisions Needed' && (CONTAINS(approverLevel, 'Level Two') || CONTAINS(approverLevel, 'Level Three'))}"
                  >
                    <apex:commandButton
                      action="{!sendBackPopup}"
                      value="Send Back"
                      status="pageStatus"
                    />
                    <apex:commandButton
                      value="Deny"
                      action="{!denyPopup}"
                      status="pageStatus"
                    />
                    <apex:commandButton
                      value="Approve"
                      action="{!approveBudget}"
                      status="pageStatus"
                      styleClass="primary"
                      reRender="form"
                    />
                  </apex:outputPanel>
                </apex:outputPanel>
                <apex:outputPanel
                  rendered="{!editMode && isNationalSubGrant && approverLevel == 'Level Three Admin'}"
                >
                  <apex:commandButton
                    action="{!sendBackPopup}"
                    value="Send Back"
                    status="pageStatus"
                  />
                  <apex:commandButton
                    value="Deny"
                    action="{!denyPopup}"
                    status="pageStatus"
                  />
                  <apex:commandButton
                    value="Approve"
                    action="{!approveBudget}"
                    status="pageStatus"
                    styleClass="primary"
                    reRender="form"
                  />
                </apex:outputPanel>
              </apex:outputPanel>
              <apex:outputPanel rendered="{!grant.Grant_Status__c == 'Closed'}">
                <apex:commandButton
                  value="View Reimbursements"
                  action="{!URLFOR($Site.Prefix+'/Reimbursements?grantId='+ grant.Id +'&grantStatus=Closed')}"
                />
              </apex:outputPanel>
              <apex:commandButton
                value="Close Grant"
                action="{!showcloseGrantPopup}"
                reRender="form"
                rendered="{!canCloseGrant && CONTAINS(approverLevel, 'Admin')}"
                style="margin-left: 8px"
              />
              <apex:commandButton
                value="Reopen Grant"
                action="{!reopenGrant}"
                rendered="{!canReopenGrant && CONTAINS(approverLevel, 'Admin')}"
              />
            </div>
            <div class="col-xs-4 pull-right text-right">
              <apex:outputPanel rendered="{!editMode}">
                <h4 style="padding-right: 10px">
                  Updated Requested Amount: &nbsp;
                  <apex:outputText value="${0, number, ###,###,###,##0.00}">
                    <apex:param value="{!updatedRequestedAmount}" />
                  </apex:outputText>
                </h4>
              </apex:outputPanel>
            </div>
          </div>
          <!-- END Page Actions -->
        </apex:outputPanel>

        <apex:outputPanel id="budgetNotesPopup">
          <apex:outputPanel
            styleClass="popupBackground"
            layout="block"
            rendered="{!displayBudgetNotesPopup}"
          />
          <apex:outputPanel
            styleClass="custPopup"
            layout="block"
            rendered="{!displayBudgetNotesPopup}"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title">Add a note</h4>
                </div>
                <div class="modal-body">
                  <h5>Notes for Affiliate:</h5>
                  <apex:inputField value="{!grant.Budget_Notes__c}" />
                  <br />
                  <h5>Notes for National:</h5>
                  <apex:inputField value="{!grant.Notes_for_National__c}" />
                  <apex:pageMessages></apex:pageMessages>
                </div>
                <div class="modal-footer">
                  <apex:commandButton
                    action="{!cancelBudgetNotesPopup}"
                    value="Cancel"
                    status="pageStatus"
                    reRender="budgetNotesPopup"
                  />
                  <apex:commandButton
                    value="Save"
                    action="{!saveNotes}"
                    status="pageStatus"
                    styleClass="primary"
                    rendered="{!sendBack == false && deny == false}"
                    reRender="form"
                  />
                  <apex:commandButton
                    value="Send Back Budget Request"
                    action="{!sendBack}"
                    status="pageStatus"
                    styleClass="primary"
                    rendered="{!sendBack == true}"
                    reRender="form"
                  />
                  <apex:commandButton
                    value="Deny Budget Request"
                    action="{!denyBudget}"
                    status="pageStatus"
                    styleClass="primary"
                    rendered="{!deny == true}"
                    reRender="form"
                  />
                </div>
              </div>
            </div>
          </apex:outputPanel>
        </apex:outputPanel>

        <apex:outputPanel id="updatePopup">
          <apex:outputPanel
            styleClass="popupBackground"
            layout="block"
            rendered="{!displayUpdatePopup}"
          />
          <apex:outputPanel
            styleClass="custPopup"
            layout="block"
            rendered="{!displayUpdatePopup}"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title">Update Budget</h4>
                </div>
                <div class="modal-body">
                  Due to the increase of the grant period through the no-cost
                  extension, all fields will recalculate once you update your
                  budget. You will need to rebalance your budget to the Total
                  Awarded Amount
                </div>
                <div class="modal-footer">
                  <apex:commandButton
                    action="{!cancelUpdatePopup}"
                    value="Cancel"
                    status="pageStatus"
                    reRender="updatePopup"
                  />
                  <a
                    class="btn primary"
                    href="{!URLFOR($Site.Prefix+'/BBBSBudgetPersonnel?GrantID='+GrantID)}"
                  >
                    Update Budget
                  </a>
                </div>
              </div>
            </div>
          </apex:outputPanel>
        </apex:outputPanel>

        <apex:outputPanel id="uploadAwardPopup">
          <apex:outputPanel
            styleClass="popupBackground"
            layout="block"
            rendered="{!displayAwardPopup}"
          />
          <apex:outputPanel
            styleClass="custPopup"
            layout="block"
            rendered="{!displayAwardPopup}"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title">Update Award Amount</h4>
                </div>
                <div class="modal-body">
                  <span style="font-weight: bold">
                    Award Amount: &nbsp;&nbsp;
                  </span>
                  $<apex:inputField
                    value="{!grant.Amount__c}"
                    styleClass="input-md"
                  />
                  <!--<br /><br />
<iframe id="attachmentIFrame" frameborder="0" width="100%" height="200px"
src="{!URLFOR($Site.Prefix+'/AttachmentUpload?ParentId='+ grant.Id +'&filename=LOA')}">
</iframe>-->
                </div>
                <div class="modal-footer">
                  <apex:commandButton
                    action="{!hideAwardPopup}"
                    value="Cancel"
                    status="pageStatus"
                    reRender="uploadAwardPopup"
                  />
                  <apex:commandButton
                    action="{!updateAward}"
                    value="Save"
                    status="pageStatus"
                  />
                </div>
              </div>
            </div>
          </apex:outputPanel>
        </apex:outputPanel>

        <c:ConfirmationPopup
          header="Close Grant"
          body="Closing this grants will also close all related reimbursement requests."
          displayConfirmPopup="{!displayCloseGrantPopup}"
        >
          <apex:commandButton value="Cancel" action="{!hideCloseGrantPopup}" />
          <apex:commandButton
            value="Close Grant"
            styleClass="primary"
            action="{!closeGrant}"
          />
        </c:ConfirmationPopup>

        <br />
        <div class="alert alert-info" role="alert">
          <strong>
            You won't be able to submit a reimbursement until you have an
            approved budget.
          </strong>
        </div>

        <c:ErrorMessage
          type="info"
          rendered="{!CONTAINS(grant.Name, 'JJ7')}"
          errorMessage="A No-Cost Extension was granted for JJ7 2017-JU-FX-0002, making the subgrantee performance period 10/1/2017 – 12/31/2018"
        />
        <c:ErrorMessage
          type="info"
          rendered="{!CONTAINS(grant.Name, 'JJ7')}"
          errorMessage="Personnel Start Date and End Date are for budget line item calculation purposes only"
        />

        <c:ErrorMessage errorMessage="{!errorMessage}" />
        <apex:pageMessages></apex:pageMessages>
      </div>
    </div>
  </apex:form>
</apex:page>
